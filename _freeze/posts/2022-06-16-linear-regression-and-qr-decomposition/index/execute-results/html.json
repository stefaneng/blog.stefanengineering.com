{
  "hash": "b209e2ff71b5a85d4e6a1a3b804e3f30",
  "result": {
    "markdown": "---\ntitle: Linear Regression and QR decomposition\nauthor: Stefan Eng\ndate: '2022-06-16'\nslug: linear-regression-and-qr-decomposition\ncategories:\n  - statistics\n  - R\n  - math\ntags:\n  - R\ndraft: yes\noutput:\n  html: default\n  blogdown::html_page:\n    toc: no\n    fig_width: 5\n    fig_height: 5\nlink-citations: yes\ncsl: ../../static/bibtex/acm-sig-proceedings.csl\nbibliography: ../../static/bibtex/linearmodeling.bib\n---\n\n::: {.cell}\n\n:::\n\n\n## Setup\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(here)\n\n# CB Palette like ESL\ncbPalette <- c(\n  \"#999999\", \"#E69F00\", \"#56B4E9\", \"#009E73\",\n  \"#F0E442\", \"#0072B2\", \"#D55E00\", \"#CC79A7\")\n\n# Set the theme\ntheme_set(\n  theme_minimal(base_size = 15, base_family = \"Arial\") %+replace%\n    theme(plot.caption = element_text(size = 9, color = \"gray50\", hjust=1))\n)\n```\n:::\n\n\n## Introduction\nMost of this content was taken from [@wood_gam_book]\n\n## QR Decomposition\nAny real-valued matrix $X$ ($n \\times p$) can be decomposed as\n$$\nX = Q_f R = Q\\begin{bmatrix}R\\\\0\\end{bmatrix}\n$$\nwhere $Q$ is an $n \\times n$ orthogonal matrix. In the alternate formulation, $Q_f$ is the first $p$ columns of $Q$, so $Q_f$ is $n \\times p$ with orthogonal columns. $R$ is a $p \\times p$ upper triangular matrix such that $R_{i,j} = 0$ if $i > j$.\nSome of the nice properties about these matrices are that \n\n$$\n\\begin{aligned}\nQ^T &= Q^{-1}\\\\\nQ^T Q &= Q Q^T = I_{n}\\\\\nQ_f^T Q_f &= I_{p}\\\\\nQ u \\cdot Q v &= u \\cdot v && \\text{for } u,v \\in R^{n}\\\\\n\\| Q u \\| &= \\| u \\| && \\text{for all } u \\in R^{n}\n\\end{aligned}\n$$\n\n## Length is preserved\nAssume $Q$ is a $n \\times n$ orthogonal matrix and $v$ is a $n \\times 1$ vector. Then,\n\n$$\n\\begin{aligned}\n\\|Q v \\| &= Qv \\cdot Qv\\\\\n&= (Qv)^T Qv\\\\\n&= v Q^T Q v\\\\\n&= v \\cdot v\\\\\n&= \\|v \\|\n\\end{aligned}\n$$\n\n## Why use QR Decomposition?\n\nThe standard estimator for the coefficients is easy enough to derive\n$$\n\\hat{\\beta} = (X^T X)^{-1} X^T y\n$$\n\nInverting matrices can be unstable and fail when attempting to invert using R.\nThis can occur if the columns are completely different scales.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmu <- 1e7\nX0 <- cbind(rnorm(10, mean = mu, sd = 100), rnorm(10))\nX <- cbind(1, X0)\ny <- rnorm(10)\n# solve(t(X) %*% X)\ntryCatch(\n  expr = solve(crossprod(X)),\n  error = function(e) {\n    print(e)\n    warning(e)\n  }\n)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n<simpleError in solve.default(crossprod(X)): system is computationally singular: reciprocal condition number = 7.20484e-25>\n```\n:::\n\n```{.r .cell-code}\n# crossprod(apply(X0, 2, scale))\n# kappa(crossprod(X))\n# kappa(apply(X0, 2, scale))\n\nprint(chol2inv(chol(crossprod(X))))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n              [,1]          [,2]          [,3]\n[1,]  1.387976e+09 -1.387986e+02  2.426855e+02\n[2,] -1.387986e+02  1.387995e-05 -2.426886e-05\n[3,]  2.426855e+02 -2.426886e-05  4.874504e-02\n```\n:::\n\n```{.r .cell-code}\nprint(chol2inv(qr.R(qr(X))))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n              [,1]          [,2]          [,3]\n[1,]  1.387982e+09 -1.387991e+02  2.426865e+02\n[2,] -1.387991e+02  1.388001e-05 -2.426895e-05\n[3,]  2.426865e+02 -2.426895e-05  4.874504e-02\n```\n:::\n:::\n\n\n## Results\n$$\n\\begin{aligned}\n\\hat{\\beta} &= R^{-1} f\n\\end{aligned}\n$$\n\n## Assorted Problems\n\n### Residuals\nFrom problem 1.6 from Wood's GAM book:\n\n$$\nX^T \\hat{\\mu} = X^T y\n$$\n\nWhat implications does this have for the residuals of a model which includes an intercept term?\n\nFrom section on 'The influence matrix':\n\n$\\mathbf{Q}_f$ is first $p$ columns of $\\mathbf{Q}, f = \\mathbf{Q}_f y$ so\n$$\n\\hat{\\beta} = \\mathbf{R}^{-1}\\mathbf{Q}_f^T y\n$$\nThen,\n$$\n\\begin{aligned}\nX^T \\hat{\\mu} &= X^T X \\hat{\\beta}\\\\\n&= X^T X R^{-1} Q_f^T y\\\\\n&= X^T Q_f R R^{-1} Q_f^T y\\\\\n&= X^T Q_f Q_f^T y && \\\\\n&= (Q_f R)^T Q_f Q_f^T y\\\\\n&= R^T Q_f^T Q_f Q_f^T y\\\\\n&= R^T Q_f^T y\\\\\n&= (Q_f R)^T y\\\\\n&= X^T y\\\\\n\\end{aligned}\n$$\n\nNote that $Q_f$ is only semi-orthogonal so $Q_f Q_f^T = A$ the influence matrix, is actually the orthogonal projection onto the column space of $Q_f$.\n\nWhat does this mean for the residuals which includes an intercept term?\n\nSince $\\hat{\\epsilon} = \\hat{\\mu} - y$, then\n$$\n\\begin{aligned}\nX^T \\hat{\\epsilon} = X^T\\hat{\\mu} - X^T y &= 0\\\\\n\\begin{bmatrix}\n1 & 1 & \\cdots & 1\\\\\nx_{11} & x_{21} & \\cdots & x_{n1}\\\\\nx_{12} & x_{22} & \\cdots & x_{n2}\\\\\n\\vdots & \\ddots & & \\\\\nx_{1p} & x_{2p} & \\cdots & x_{np}\n\\end{bmatrix}\n\\begin{bmatrix}\n\\hat{\\epsilon}_1 & \\hat{\\epsilon}_2 & \\cdots & \\hat{\\epsilon}_n\n\\end{bmatrix}^{T} &=\n\\begin{bmatrix}\n\\hat{\\epsilon}_1 + \\hat{\\epsilon}_2 + \\cdots + \\hat{\\epsilon}_n\\\\\nx_{11} \\hat{\\epsilon}_1 + x_{21} \\hat{\\epsilon}_2 + \\cdots + x_{n1} \\hat{\\epsilon}_n\\\\\n\\ldots\\\\\nx_{1p}\\hat{\\epsilon}_1 + x_{2p} \\hat{\\epsilon}_2 + \\cdots + x_{np} \\hat{\\epsilon}_n\\\n\\end{bmatrix} = 0\n\\end{aligned}\n$$\n\nThis means that if we have an intercept, then the residuals need to sum to zero:\n\n$$\n\\sum_{i = 1}^n \\hat{\\epsilon}_i = 0\n$$\n\n## References\n\n## Reproducibility\n\n\n::: {.cell}\n::: {.cell-output .cell-output-stdout}\n```\n─ Session info ───────────────────────────────────────────────────────────────────────────────────────────────────────\n setting  value\n version  R version 4.2.1 (2022-06-23)\n os       macOS Catalina 10.15.7\n system   x86_64, darwin17.0\n ui       X11\n language (EN)\n collate  en_US.UTF-8\n ctype    en_US.UTF-8\n tz       America/Los_Angeles\n date     2022-12-11\n pandoc   2.19.2 @ /Applications/RStudio.app/Contents/MacOS/quarto/bin/tools/ (via rmarkdown)\n\n─ Packages ───────────────────────────────────────────────────────────────────────────────────────────────────────────\n ! package       * version date (UTC) lib source\n P assertthat      0.2.1   2019-03-21 [?] CRAN (R 4.2.0)\n P backports       1.4.1   2021-12-13 [?] CRAN (R 4.2.0)\n P broom           1.0.1   2022-08-29 [?] CRAN (R 4.2.0)\n P cellranger      1.1.0   2016-07-27 [?] CRAN (R 4.2.0)\n P cli             3.4.1   2022-09-23 [?] CRAN (R 4.2.0)\n P colorspace      2.0-3   2022-02-21 [?] CRAN (R 4.2.0)\n P crayon          1.5.2   2022-09-29 [?] CRAN (R 4.2.0)\n P DBI             1.1.3   2022-06-18 [?] CRAN (R 4.2.0)\n P dbplyr          2.2.1   2022-06-27 [?] CRAN (R 4.2.0)\n P digest          0.6.31  2022-12-11 [?] CRAN (R 4.2.1)\n P dplyr         * 1.0.10  2022-09-01 [?] CRAN (R 4.2.0)\n P ellipsis        0.3.2   2021-04-29 [?] CRAN (R 4.2.0)\n P evaluate        0.18    2022-11-07 [?] CRAN (R 4.2.0)\n P fansi           1.0.3   2022-03-24 [?] CRAN (R 4.2.0)\n P fastmap         1.1.0   2021-01-25 [?] CRAN (R 4.2.0)\n P forcats       * 0.5.2   2022-08-19 [?] CRAN (R 4.2.0)\n P fs              1.5.2   2021-12-08 [?] CRAN (R 4.2.0)\n P gargle          1.2.1   2022-09-08 [?] CRAN (R 4.2.0)\n P generics        0.1.3   2022-07-05 [?] CRAN (R 4.2.0)\n P ggplot2       * 3.4.0   2022-11-04 [?] CRAN (R 4.2.0)\n P glue            1.6.2   2022-02-24 [?] CRAN (R 4.2.0)\n P googledrive     2.0.0   2021-07-08 [?] CRAN (R 4.2.0)\n P googlesheets4   1.0.1   2022-08-13 [?] CRAN (R 4.2.0)\n P gtable          0.3.1   2022-09-01 [?] CRAN (R 4.2.0)\n P haven           2.5.1   2022-08-22 [?] CRAN (R 4.2.0)\n P here          * 1.0.1   2020-12-13 [?] CRAN (R 4.2.0)\n P hms             1.1.2   2022-08-19 [?] CRAN (R 4.2.0)\n P htmltools       0.5.4   2022-12-07 [?] CRAN (R 4.2.0)\n P htmlwidgets     1.5.4   2021-09-08 [?] CRAN (R 4.2.0)\n P httr            1.4.4   2022-08-17 [?] CRAN (R 4.2.1)\n P jsonlite        1.8.4   2022-12-06 [?] CRAN (R 4.2.1)\n P knitr           1.41    2022-11-18 [?] CRAN (R 4.2.1)\n P lifecycle       1.0.3   2022-10-07 [?] CRAN (R 4.2.0)\n P lubridate       1.9.0   2022-11-06 [?] CRAN (R 4.2.0)\n P magrittr        2.0.3   2022-03-30 [?] CRAN (R 4.2.0)\n P modelr          0.1.10  2022-11-11 [?] CRAN (R 4.2.0)\n P munsell         0.5.0   2018-06-12 [?] CRAN (R 4.2.0)\n P pillar          1.8.1   2022-08-19 [?] CRAN (R 4.2.0)\n P pkgconfig       2.0.3   2019-09-22 [?] CRAN (R 4.2.0)\n P purrr         * 0.3.5   2022-10-06 [?] CRAN (R 4.2.0)\n P R6              2.5.1   2021-08-19 [?] CRAN (R 4.2.0)\n P readr         * 2.1.3   2022-10-01 [?] CRAN (R 4.2.0)\n P readxl          1.4.1   2022-08-17 [?] CRAN (R 4.2.0)\n   renv            0.16.0  2022-09-29 [1] CRAN (R 4.2.0)\n P reprex          2.0.2   2022-08-17 [?] CRAN (R 4.2.0)\n P rlang           1.0.6   2022-09-24 [?] CRAN (R 4.2.0)\n P rmarkdown       2.18    2022-11-09 [?] CRAN (R 4.2.0)\n P rprojroot       2.0.3   2022-04-02 [?] CRAN (R 4.2.0)\n P rstudioapi      0.14    2022-08-22 [?] CRAN (R 4.2.0)\n P rvest           1.0.3   2022-08-19 [?] CRAN (R 4.2.0)\n P scales          1.2.1   2022-08-20 [?] CRAN (R 4.2.0)\n P sessioninfo   * 1.2.2   2021-12-06 [?] CRAN (R 4.2.0)\n P stringi         1.7.8   2022-07-11 [?] CRAN (R 4.2.0)\n P stringr       * 1.5.0   2022-12-02 [?] CRAN (R 4.2.0)\n P tibble        * 3.1.8   2022-07-22 [?] CRAN (R 4.2.0)\n P tidyr         * 1.2.1   2022-09-08 [?] CRAN (R 4.2.0)\n P tidyselect      1.2.0   2022-10-10 [?] CRAN (R 4.2.0)\n P tidyverse     * 1.3.2   2022-07-18 [?] CRAN (R 4.2.0)\n P timechange      0.1.1   2022-11-04 [?] CRAN (R 4.2.0)\n P tzdb            0.3.0   2022-03-28 [?] CRAN (R 4.2.0)\n P utf8            1.2.2   2021-07-24 [?] CRAN (R 4.2.0)\n P vctrs           0.5.1   2022-11-16 [?] CRAN (R 4.2.0)\n P withr           2.5.0   2022-03-03 [?] CRAN (R 4.2.0)\n P xfun            0.35    2022-11-16 [?] CRAN (R 4.2.0)\n P xml2            1.3.3   2021-11-30 [?] CRAN (R 4.2.0)\n P yaml            2.3.6   2022-10-18 [?] CRAN (R 4.2.0)\n\n [1] /Users/stefaneng/personal_devel/stefanengineering.comV3/renv/library/R-4.2/x86_64-apple-darwin17.0\n [2] /Users/stefaneng/personal_devel/stefanengineering.comV3/renv/sandbox/R-4.2/x86_64-apple-darwin17.0/84ba8b13\n\n P ── Loaded and on-disk path mismatch.\n\n──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────\n```\n:::\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}